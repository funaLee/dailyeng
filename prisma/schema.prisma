generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Level {
  A1
  A2
  B1
  B2
  C1
  C2
}

enum PartOfSpeech {
  noun
  verb
  adjective
  adverb
  preposition
  conjunction
  pronoun
  interjection
  phrase
}

enum QuizType {
  multiple_choice @map("multiple-choice")
  fill_blank      @map("fill-blank")
  matching
}

enum Role {
  user
  tutor
}

enum StudyGoal {
  casual
  intermediate
  fluent
  conversation
  travel
  work
  exam
}

enum TaskType {
  vocab
  grammar
  speaking
  listening
}

enum NotificationType {
  speaking
  vocabulary
  grammar
  achievement
  system
}

enum ShopItemCategory {
  power_up  @map("Power-up")
  boost     @map("Boost")
  cosmetic  @map("Cosmetic")
  access    @map("Access")
  learning  @map("Learning")
  analytics @map("Analytics")
}

enum CollectionRarity {
  common
  rare
  epic
  legendary
  mythical
  ssr
}

enum CollectionType {
  daily
  gadget
  character
  poster
  ssr_collab
}

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  password String?
  image    String?

  // Profile fields
  phoneNumber String?
  dateOfBirth DateTime?
  gender      String?
  address     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profileStats     ProfileStats?
  studyPlan        StudyPlan?
  flashcards       Flashcard[]
  speakingSessions SpeakingSession[]
  topicProgress    UserTopicProgress[]

  // New relations
  notifications        Notification[]
  notebookItems        NotebookItem[]
  placementTestResults PlacementTestResult[]
  inventory            UserInventory[]
  collection           UserCollection[]
  courseRegistrations  UserCourseRegistration[]
}

model ProfileStats {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  xp                   Int      @default(0)
  streak               Int      @default(0)
  totalLearningMinutes Int      @default(0)
  badges               String[] // Stored as array of strings

  vocabScore     Int @default(0)
  grammarScore   Int @default(0)
  speakingScore  Int @default(0)
  listeningScore Int @default(0)
  readingScore   Int @default(0)
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
}

model Topic {
  id            String  @id @default(cuid())
  title         String
  description   String
  level         Level
  wordCount     Int
  estimatedTime Int
  thumbnail     String?

  vocabItems        VocabItem[]
  grammarNotes      GrammarNote[]
  quizItems         QuizItem[]
  listeningTasks    ListeningTask[]
  readingPassages   ReadingPassage[]
  speakingScenarios SpeakingScenario[]
  userProgress      UserTopicProgress[]
  registrations     UserCourseRegistration[]
}

model UserTopicProgress {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId  String
  topic    Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  progress Int    @default(0)

  @@unique([userId, topicId])
}

model UserCourseRegistration {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId      String
  topic        Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  status       String // active, expired, etc.
  registeredAt DateTime  @default(now())
  expiredAt    DateTime?
}

model VocabItem {
  id                 String       @id @default(cuid())
  topicId            String
  topic              Topic        @relation(fields: [topicId], references: [id], onDelete: Cascade)
  word               String
  pronunciation      String
  meaning            String
  vietnameseMeaning  String
  partOfSpeech       PartOfSpeech
  collocations       String[]
  exampleSentence    String
  exampleTranslation String
}

model NotebookItem {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word         String
  meaning      String[]
  examples     Json // Array of {en: string, vi: string}
  note         String?
  tags         String[]
  collectionId String // e.g. "vocabulary", "grammar"
  masteryLevel Int      @default(0)
  isStarred    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model GrammarNote {
  id          String @id @default(cuid())
  topicId     String
  topic       Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  title       String
  explanation String
  examples    Json // Array of {en: string, vi: string}
}

model QuizItem {
  id            String   @id @default(cuid())
  topicId       String
  topic         Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  question      String
  type          QuizType
  options       String[]
  correctAnswer String
  explanation   String
}

model ListeningTask {
  id            String   @id @default(cuid())
  topicId       String
  topic         Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  type          String // dictation, mcq, etc.
  question      String
  audioUrl      String
  transcript    String
  options       String[]
  correctAnswer String
}

model ReadingPassage {
  id        String @id @default(cuid())
  topicId   String
  topic     Topic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  title     String
  content   String
  glossary  Json // Array of objects
  questions Json // Array of objects
}

model SpeakingScenario {
  id          String  @id @default(cuid())
  topicId     String? // Optional link to a topic
  topic       Topic?  @relation(fields: [topicId], references: [id])
  title       String
  description String
  goal        String
  difficulty  Level?
  context     String

  sessions SpeakingSession[]
}

model SpeakingSession {
  id         String           @id @default(cuid())
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  scenarioId String
  scenario   SpeakingScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now())

  turns SpeakingTurn[]
}

model SpeakingTurn {
  id        String          @id @default(cuid())
  sessionId String
  session   SpeakingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role      Role
  text      String
  audioUrl  String?
  timestamp DateTime        @default(now())

  // Scores
  pronunciationScore Int?
  fluencyScore       Int?
  grammarScore       Int?
  contentScore       Int?
}

model Flashcard {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId      String? // Optional link to topic
  front        String
  back         String
  createdAt    DateTime  @default(now())
  lastReviewed DateTime?
  interval     Int       @default(0)
  easeFactor   Float     @default(2.5)
  repetitions  Int       @default(0)
}

model StudyPlan {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal          StudyGoal
  level         Level
  minutesPerDay Int
  createdAt     DateTime  @default(now())

  tasks StudyTask[]
}

model StudyTask {
  id        String    @id @default(cuid())
  planId    String
  plan      StudyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  date      DateTime
  type      TaskType
  completed Boolean   @default(false)
}

model PlacementTestResult {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  score     Int
  level     Level
  breakdown Json // JSON object for section scores
  createdAt DateTime @default(now())
}

model ShopItem {
  id          String           @id @default(cuid())
  name        String
  description String
  category    ShopItemCategory
  price       Int
  icon        String
  image       String?
  details     String?
  status      String // available, active, etc.

  inventory UserInventory[]
}

model UserInventory {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId       String
  item         ShopItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  status       String // active, used
  purchaseDate DateTime  @default(now())
  expiryDate   DateTime?
}

model CollectionItem {
  id       String           @id @default(cuid())
  name     String
  type     CollectionType
  rarity   CollectionRarity
  image    String
  metadata Json? // For specific attributes like movieName, ability, etc.

  users UserCollection[]
}

model UserCollection {
  id         String         @id @default(cuid())
  userId     String
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId     String
  item       CollectionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  obtainedAt DateTime       @default(now())
}
